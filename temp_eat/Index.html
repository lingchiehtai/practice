<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #FF95CA;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    select { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
    .text-shadow-pink { text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.15), 0px 0px 10px rgba(255, 255, 255, 0.2); }
    #filter-panel { transition: all 0.3s ease-in-out; transform-origin: top right; }
    #filter-panel.hidden { display: none; opacity: 0; transform: scale(0.95); }
  </style>
</head>

<body class="bg-[#FFF7FB] min-h-screen text-gray-800">
  <div class="max-w-md mx-auto bg-white min-h-screen shadow-lg flex flex-col relative">
    
    <header class="bg-[#FF95CA] text-white py-1.5 px-3 sticky top-0 z-40 shadow-md flex items-center justify-between min-h-[50px]">
      <h1 class="text-xl font-black flex items-center gap-2 tracking-tight text-shadow-pink">
        <i class="fa-solid fa-map-location-dot text-lg"></i>
        <span>景點美食清單</span>
      </h1>
      <button id="search-toggle" class="w-9 h-9 flex items-center justify-center hover:bg-pink-400 rounded-full transition-colors">
        <i class="fa-solid fa-magnifying-glass text-lg"></i>
      </button>
    </header>

    <div id="filter-panel" class="hidden absolute top-12 right-3 left-3 bg-white border border-pink-100 shadow-xl rounded-2xl z-50 p-3"> 
      <div class="space-y-3"> 
        <div>
          <label class="block text-[10px] text-pink-400 font-bold mb-0.5 ml-1 uppercase">Keyword Search</label>
          <div class="relative">
            <input type="text" id="keyword-search" placeholder="搜尋店名、餐點..." class="w-full px-4 py-2 text-sm rounded-xl border border-gray-100 bg-gray-50 text-gray-700 focus:ring-2 focus:ring-pink-200 outline-none">
            <i class="fa-solid fa-xmark absolute right-3 top-2.5 text-gray-300 cursor-pointer" id="clear-search"></i>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-[10px] text-pink-400 font-bold mb-0.5 ml-1 uppercase">Location</label>
            <div class="relative">
              <select id="filter-location" class="block w-full pl-3 pr-8 py-2 text-sm bg-gray-50 border border-gray-100 rounded-xl text-gray-700 outline-none cursor-pointer">
                <option value="All">全部地區</option>
              </select>
              <i class="fa-solid fa-chevron-down absolute right-3 top-3 text-[10px] text-gray-400 pointer-events-none"></i>
            </div>
          </div>
          <div>
            <label class="block text-[10px] text-pink-400 font-bold mb-0.5 ml-1 uppercase">Category</label>
            <div class="relative">
              <select id="filter-category" class="block w-full pl-3 pr-8 py-2 text-sm bg-gray-50 border border-gray-100 rounded-xl text-gray-700 outline-none cursor-pointer">
                <option value="All">全部分類</option>
              </select>
              <i class="fa-solid fa-chevron-down absolute right-3 top-3 text-[10px] text-gray-400 pointer-events-none"></i>
            </div>
          </div>
        </div>
        <button id="close-panel" class="w-1/2 mx-auto mt-1 py-2 bg-white hover:bg-gray-50 active:scale-95 text-gray-900 rounded-xl text-xs font-black border border-gray-100 flex items-center justify-center gap-2 shadow-sm transition-all">
          <i class="fa-solid fa-chevron-up text-[10px] text-gray-400"></i>
          <span>收起篩選</span>
        </button>
      </div>
    </div>

    <div id="filter-status-bar" class="hidden bg-white border-b-2 border-pink-100 px-4 py-3 flex items-center justify-between shadow-sm">
      <div class="flex items-center gap-2 overflow-hidden">
        <span class="text-xs font-black text-pink-500 uppercase flex-shrink-0 tracking-wider">篩選中:</span>
        <span id="current-filter-text" class="text-sm text-gray-900 font-bold truncate"></span>
      </div>
      <button id="reset-all" class="flex-shrink-0 flex items-center gap-1 bg-gray-100 hover:bg-pink-600 hover:text-white text-gray-600 px-3 py-1.5 rounded-xl text-xs font-black transition-all active:scale-95 border border-gray-200">
        <i class="fa-solid fa-rotate-left text-[10px]"></i>
        回到 ALL
      </button>
    </div>

    <main id="card-container" class="flex-1 p-3 space-y-3 bg-[#FFF7FB]">
      <div id="loading" class="flex flex-col items-center justify-center py-20">
        <div class="loader mb-4"></div>
        <p class="text-pink-400 text-sm font-medium animate-pulse">正在準備清單...</p>
      </div>
    </main>

    <footer class="p-2 text-center text-[10px] text-gray-400 border-t bg-white">
      Powered by Google Apps Script
    </footer>
  </div>

  <script>
    let allData = [];
    let currentRenderIndex = 0;
    const BATCH_SIZE = 10;
    
    document.addEventListener('DOMContentLoaded', function() {
      fetchData();
      
      const searchToggle = document.getElementById('search-toggle');
      const filterPanel = document.getElementById('filter-panel');
      const closePanel = document.getElementById('close-panel');
      const resetBtn = document.getElementById('reset-all');
      
      searchToggle.addEventListener('click', () => {
        const isHidden = filterPanel.classList.toggle('hidden');
        if (!isHidden) document.getElementById('keyword-search').focus();
      });

      closePanel.addEventListener('click', () => filterPanel.classList.add('hidden'));
      resetBtn.addEventListener('click', resetAllFilters);

      document.getElementById('filter-location').addEventListener('change', renderCards);
      document.getElementById('filter-category').addEventListener('change', renderCards);
      document.getElementById('keyword-search').addEventListener('input', renderCards);
      document.getElementById('clear-search').addEventListener('click', () => {
        document.getElementById('keyword-search').value = '';
        renderCards();
      });
    });

    function fetchData() {
      if (typeof google === 'undefined') {
        onDataReceived([
          {location: '高雄', category: '美食', name: '成真咖啡 (高雄夢時代店)', detail1: '2025新開幕', detail2: '鬆餅,義大利麵', mapLink: '#', imageUrl:''},
          {location: '高雄', category: '景點', name: '高雄流行音樂中心', detail1: '海洋元素設計', detail2: '夜景,夕陽', mapLink: '#', imageUrl: ''}
        ]);
        return;
      }
      google.script.run.withSuccessHandler(onDataReceived).withFailureHandler(onError).getData();
    }

    function onDataReceived(data) {
      allData = data.filter(item => item.name && item.name !== "Name" && item.name !== "名稱");
      document.getElementById('loading').style.display = 'none';
      initFilters();
      renderCards();
    }

    function onError(error) {
      document.getElementById('card-container').innerHTML = `<div class="p-10 text-center text-red-500 text-xs">載入失敗: ${error.message}</div>`;
    }

    function initFilters() {
      const locs = new Set();
      const cats = new Set();
      allData.forEach(item => {
        if(item.location) locs.add(item.location);
        if(item.category) cats.add(item.category);
      });
      populateSelect('filter-location', Array.from(locs));
      populateSelect('filter-category', Array.from(cats));
    }

    function populateSelect(id, items) {
      const select = document.getElementById(id);
      const firstOption = select.options[0];
      select.innerHTML = '';
      select.appendChild(firstOption);
      items.sort().forEach(text => {
        const opt = document.createElement('option');
        opt.value = text;
        opt.textContent = text;
        select.appendChild(opt);
      });
    }

    // 在 Header 下方、內容區上方新增一個動態顯示的區塊
    function resetAllFilters() {
      document.getElementById('filter-location').value = "All";
      document.getElementById('filter-category').value = "All";
      document.getElementById('keyword-search').value = "";
      document.getElementById('filter-panel').classList.add('hidden');
      renderCards();
    }

    function renderCards() {
      const locVal = document.getElementById('filter-location').value;
      const catVal = document.getElementById('filter-category').value;
      const rawKey = document.getElementById('keyword-search').value.toLowerCase();
      
      const keywords = rawKey.split(/[&\s]+/).map(k => k.trim()).filter(k => k !== "");
      
      // 更新狀態列
      let conditions = [];
      if (locVal !== 'All' && locVal !== "") conditions.push(locVal);
      if (catVal !== 'All' && catVal !== "") conditions.push(catVal);
      if (keywords.length > 0) conditions.push(keywords.join(' & '));

      const bar = document.getElementById('filter-status-bar');
      const txt = document.getElementById('current-filter-text');
      if (conditions.length > 0) {
        bar.classList.remove('hidden');
        txt.textContent = conditions.join(' / ');
      } else {
        bar.classList.add('hidden');
      }

      const container = document.getElementById('card-container');
      container.innerHTML = ''; 
      currentRenderIndex = 0;

      const filtered = allData.filter(item => {
        const mLoc = locVal === 'All' || locVal === "" || item.location === locVal;
        const mCat = catVal === 'All' || catVal === "" || item.category === catVal;
        const target = `${item.name} ${item.location} ${item.category} ${item.detail1} ${item.detail2}`.toLowerCase();
        const mKey = keywords.length === 0 || keywords.every(k => target.includes(k));
        return mLoc && mCat && mKey;
      });

      if (filtered.length === 0) {
        container.innerHTML = '<div class="text-center py-10 text-gray-400 text-sm">找不到相關項目</div>';
        return;
      }
      displayBatch(filtered, container);
    }

    function displayBatch(data, container) {
      const nextBatch = data.slice(currentRenderIndex, currentRenderIndex + BATCH_SIZE);
      nextBatch.forEach(item => {
        const div = document.createElement('div');
        div.innerHTML = createCard(item);
        container.appendChild(div.firstElementChild);
      });
      currentRenderIndex += BATCH_SIZE;
      if (currentRenderIndex < data.length) {
        requestAnimationFrame(() => displayBatch(data, container));
      }
    }


    function createCard(item) {
      // 1. 先把圖片跟地圖按鈕處理好
      var mapBtn = item.mapLink ? 
        '<a href="' + item.mapLink + '" target="_blank" class="text-pink-600 border border-pink-200 bg-[#FFF1F8] px-2 py-1 rounded-md text-[10px] flex items-center gap-1 shadow-sm transition-all hover:bg-pink-400 hover:text-white"><i class="fa-solid fa-location-arrow text-[9px]"></i> Map</a>' : '';
      
      var imgUrl = item.imageUrl || "https://placehold.co/150x150/FFF7FB/FF95CA?text=No+Image";

      // 2. 使用標準引號串接，避免 GAS 對 ` 符號內的 class 產生語法誤判
      var html = '';
      html += '<div class="bg-white rounded-2xl shadow-sm border border-pink-100 overflow-hidden flex h-32 hover:shadow-md transition-all">';
      html += '  <div class="flex-1 p-3 flex flex-col min-w-0">';
      html += '    <div class="flex items-center justify-between mb-1 gap-2">';
      html += '      <div class="flex items-center gap-1.5 overflow-hidden text-[10px]">';
      html += '        <span class="bg-pink-50 text-pink-600 px-2 py-0.5 rounded-md font-semibold">' + item.location + '</span>';
      html += '        <span class="text-gray-300">|</span>';
      html += '        <span class="text-gray-400 truncate">' + item.category + '</span>';
      html += '      </div>';
      html += '      ' + mapBtn;
      html += '    </div>';
      html += '    <div class="flex-1 flex flex-col justify-center">';
      html += '      <h3 class="font-bold text-gray-900 text-xl leading-tight line-clamp-1 mb-1">' + item.name + '</h3>';
      html += '      <p class="text-xs text-gray-600 truncate flex items-center gap-2">';
      html += '        <i class="fa-solid fa-circle-info text-pink-200 text-[10px]"></i> ' + (item.detail1 || '-');
      html += '      </p>';
      html += '      <p class="text-[11px] text-gray-500 truncate flex items-center gap-2">';
      html += '        <i class="fa-regular fa-comment-dots text-gray-300 text-[10px]"></i> ' + (item.detail2 || '-');
      html += '      </p>';
      html += '    </div>';
      html += '  </div>';
      html += '  <div class="w-24 h-full flex-shrink-0 bg-gray-50 border-l border-pink-50 overflow-hidden">';
      html += '    <img src="' + imgUrl + '" class="w-full h-full object-cover" onerror="this.src=\'https://placehold.co/150x150?text=Error\'">';
      html += '  </div>';
      html += '</div>';
      
      return html;
    }

  </script>
</body>
</html>