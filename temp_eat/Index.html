<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #FF95CA;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    select { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
    
    /* 自定義文字陰影：讓標題更立體 */
    .text-shadow-pink {
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.15), 0px 0px 10px rgba(255, 255, 255, 0.2);
    }

    /* 彈出面板動畫 */
    #filter-panel {
      transition: all 0.3s ease-in-out;
      transform-origin: top right;
    }
    #filter-panel.hidden {
      display: none;
      opacity: 0;
      transform: scale(0.95);
    }

  </style>
</head>

<body class="bg-[#FFF7FB] min-h-screen text-gray-800">
  <div class="max-w-md mx-auto bg-white min-h-screen shadow-lg flex flex-col relative">
    
    <header class="bg-[#FF95CA] text-white py-1.5 px-3 sticky top-0 z-40 shadow-md flex items-center justify-between min-h-[50px]">
      <h1 class="text-xl font-black flex items-center gap-2 tracking-tight text-shadow-pink">
        <i class="fa-solid fa-map-location-dot text-lg"></i>
        <span> 景點美食清單</span>
      </h1>
      <button id="search-toggle" class="w-9 h-9 flex items-center justify-center hover:bg-pink-400 rounded-full transition-colors">
        <i class="fa-solid fa-magnifying-glass text-lg"></i>
      </button>
    </header>

    <div id="filter-panel" class="hidden absolute top-12 right-3 left-3 bg-white border border-pink-100 shadow-xl rounded-2xl z-50 p-3"> <div class="space-y-3"> <div>
          <label class="block text-[10px] text-pink-400 font-bold mb-0.5 ml-1 uppercase">Keyword Search</label>
          <div class="relative">
            <input type="text" id="keyword-search" placeholder="搜尋店名、餐點... (支援空格/&)" class="w-full px-4 py-2 text-sm rounded-xl border border-gray-100 bg-gray-50 text-gray-700 focus:ring-2 focus:ring-pink-200 outline-none">
            <i class="fa-solid fa-xmark absolute right-3 top-2.5 text-gray-300 cursor-pointer" id="clear-search"></i>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-[10px] text-pink-400 font-bold mb-0.5 ml-1 uppercase">Location</label>
            <div class="relative">
              <select id="filter-location" class="block w-full pl-3 pr-8 py-2 text-sm bg-gray-50 border border-gray-100 rounded-xl text-gray-700 focus:outline-none cursor-pointer appearance-none">
                <option value="" disabled selected>地區</option>
                <option value="All">全部地區</option>
              </select>
              <i class="fa-solid fa-chevron-down absolute right-3 top-3 text-[10px] text-gray-400 pointer-events-none"></i>
            </div>
          </div>
          <div>
            <label class="block text-[10px] text-pink-400 font-bold mb-0.5 ml-1 uppercase">Category</label>
            <div class="relative">
              <select id="filter-category" class="block w-full pl-3 pr-8 py-2 text-sm bg-gray-50 border border-gray-100 rounded-xl text-gray-700 focus:outline-none cursor-pointer appearance-none">
                <option value="" disabled selected>分類</option>
                <option value="All">全部分類</option>
              </select>
              <i class="fa-solid fa-chevron-down absolute right-3 top-3 text-[10px] text-gray-400 pointer-events-none"></i>
            </div>
          </div>
        </div>

        <button id="close-panel" class="w-1/2 mx-auto mt-1 py-2 bg-white hover:bg-gray-50 active:scale-95 text-gray-900 rounded-xl text-xs font-black transition-all border border-gray-100 flex items-center justify-center gap-2 shadow-sm">
          <i class="fa-solid fa-chevron-up text-[10px] text-gray-400"></i>
          <span>收起篩選</span>
      </button>

      </div>
    </div>

    <main id="card-container" class="flex-1 p-3 space-y-3 bg-[#FFF7FB]">
      <div id="loading" class="flex flex-col items-center justify-center py-20">
        <div class="loader mb-4"></div>
        <p class="text-pink-400 text-sm font-medium animate-pulse">正在準備清單...</p>
      </div>
    </main>

    <footer class="p-2 text-center text-[10px] text-gray-400 border-t bg-white">
      Powered by Google Apps Script
    </footer>
  </div>

  <script>
    let allData = [];
    let currentRenderIndex = 0;
    const BATCH_SIZE = 10;
    
    document.addEventListener('DOMContentLoaded', function() {
      fetchData();
      
      const searchToggle = document.getElementById('search-toggle');
      const filterPanel = document.getElementById('filter-panel');
      const closePanel = document.getElementById('close-panel');
      
      // 切換面板顯示/隱藏
      searchToggle.addEventListener('click', () => {
        const isHidden = filterPanel.classList.toggle('hidden');
        if (!isHidden) {
          document.getElementById('keyword-search').focus();
        }
      });

      closePanel.addEventListener('click', () => {
        filterPanel.classList.add('hidden');
      });

      // 監聽篩選動作
      document.getElementById('filter-location').addEventListener('change', renderCards);
      document.getElementById('filter-category').addEventListener('change', renderCards);
      document.getElementById('keyword-search').addEventListener('input', renderCards);
      document.getElementById('clear-search').addEventListener('click', () => {
        document.getElementById('keyword-search').value = '';
        renderCards();
      });
    });

    function fetchData() {
      if (typeof google === 'undefined') {
        onDataReceived([
          {location: '高雄', category: '美食', name: '成真咖啡 (高雄夢時代店)', detail1: '2025新開幕', detail2: '鬆餅,義大利麵', mapLink: 'https://maps.app.goo.gl/MLQa862aEk39CtSbA', imageUrl:'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQxWZDFKj6K810fkz0f9FIDnJeoFGCpHC7FAHGEF_QzC6v5pXR4jeSlJFM&s'},
          {location: '高雄', category: '景點', name: '高雄流行音樂中心', detail1: '設計以海洋、港灣元素為靈感', detail2: '港邊,夕陽,夜景', mapLink: 'https://maps.app.goo.gl/5GhQMnFribr2uFRdA', imageUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQx6tiZeiMcgaFn51o7Rk40Rw1CoBNXxQS35wDPtE57h5JcxoH97KSCBQ&s'}
        ]);
        return;
      }
      google.script.run.withSuccessHandler(onDataReceived).withFailureHandler(onError).getData();
    }

    function onDataReceived(data) {
      allData = data.filter(item => item.name && item.name !== "Name" && item.name !== "名稱");
      const loadingDiv = document.getElementById('loading');
      if(loadingDiv) loadingDiv.style.display = 'none';
      initFilters();
      renderCards();
    }

    function onError(error) {
      document.getElementById('card-container').innerHTML = `<div class="text-center py-10 text-red-500 text-xs">載入錯誤: ${error.message}</div>`;
    }

    function initFilters() {
      const locations = new Set();
      const categories = new Set();
      allData.forEach(item => {
        if(item.location) locations.add(item.location);
        if(item.category) categories.add(item.category);
      });
      populateSelect('filter-location', Array.from(locations));
      populateSelect('filter-category', Array.from(categories));
    }

    function populateSelect(elementId, items) {
      const select = document.getElementById(elementId);
      const titleOption = select.options[0];
      const allOption = select.options[1];
      select.innerHTML = '';
      select.appendChild(titleOption);
      select.appendChild(allOption);
      items.sort().forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = item;
        select.appendChild(option);
      });
    }

    function renderCards() {
      const locVal = document.getElementById('filter-location').value;
      const catVal = document.getElementById('filter-category').value;
      const rawKeyword = document.getElementById('keyword-search').value.toLowerCase(); 
      
      const locationFilter = (locVal === "" || locVal === "All") ? 'All' : locVal;
      const categoryFilter = (catVal === "" || catVal === "All") ? 'All' : catVal;
      const keywords = rawKeyword.split(/[&\s]+/).map(k => k.trim()).filter(k => k !== "");

      const container = document.getElementById('card-container');
      container.innerHTML = ''; 
      currentRenderIndex = 0;

      const filteredData = allData.filter(item => {
        const matchLocation = locationFilter === 'All' || item.location === locationFilter;
        const matchCategory = categoryFilter === 'All' || item.category === categoryFilter;
        const searchTarget = `${item.name} ${item.location} ${item.category} ${item.detail1} ${item.detail2}`.toLowerCase();
        const matchKeywords = keywords.length === 0 || keywords.every(k => searchTarget.includes(k));
        return matchLocation && matchCategory && matchKeywords;
      });

      if (filteredData.length === 0) {
        container.innerHTML = '<div class="text-center py-10 text-gray-400 text-sm">找不到項目</div>';
        return;
      }
      displayBatch(filteredData, container);
    }

    function displayBatch(data, container) {
      const nextBatch = data.slice(currentRenderIndex, currentRenderIndex + BATCH_SIZE);
      nextBatch.forEach(item => {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = createCard(item);
        container.appendChild(tempDiv.firstElementChild);
      });
      currentRenderIndex += BATCH_SIZE;
      if (currentRenderIndex < data.length) {
        requestAnimationFrame(() => displayBatch(data, container));
      }
    }

    function createCard(item) {
      const mapButton = item.mapLink ? 
        `<a href="${item.mapLink}" target="_blank" class="text-pink-600 hover:text-white hover:bg-pink-400 text-[10px] flex items-center gap-1 border border-pink-200 bg-[#FFF1F8] px-2.5 py-1 rounded-md transition-all ml-auto flex-shrink-0 shadow-sm">
          <i class="fa-solid fa-location-arrow text-[9px]"></i> Map
        </a>` : '';

      const imageUrl = item.imageUrl || `https://placehold.co/150x150/FFF7FB/FF95CA?text=No+Image`;

      return `
        <div class="card-item bg-white rounded-2xl shadow-sm border border-pink-100 overflow-hidden flex h-32 transition-all hover:shadow-md">
          <div class="flex-1 p-3 flex flex-col min-w-0">
            <div class="flex items-center justify-between mb-1 gap-2">
              <div class="flex items-center gap-1.5 overflow-hidden">
                <span class="bg-pink-50 text-pink-600 px-2 py-0.5 rounded-md text-[10px] font-semibold truncate">${item.location}</span>
                <span class="text-gray-300 text-[10px]">|</span>
                <span class="text-gray-400 text-[10px] truncate">${item.category}</span>
              </div>
              ${mapButton}
            </div>
            <div class="flex-1 flex flex-col justify-center">
              <h3 class="font-bold text-gray-900 text-xl leading-tight line-clamp-1 mb-1">${item.name}</h3>
              <div class="space-y-0.5">
                <p class="text-xs text-gray-600 line-clamp-1 flex items-center gap-2">
                  <i class="fa-solid fa-circle-info text-pink-300 text-[10px] w-3 text-center"></i>
                  <span class="truncate">${item.detail1 || '-'}</span>
                </p>
                <p class="text-[11px] text-gray-500 line-clamp-1 flex items-center gap-2">
                  <i class="fa-regular fa-comment-dots text-gray-400 text-[10px] w-3 text-center"></i>
                  <span class="truncate">${item.detail2 || '-'}</span>
                </p>
              </div>
            </div>
          </div>
          <div class="w-24 h-full flex-shrink-0 bg-gray-50 border-l border-pink-50 flex items-center justify-center overflow-hidden">
            <img src="${imageUrl}" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\'text-gray-300\'><i class=\'fa-solid fa-image text-lg\'></i></div>';" class="w-full h-full object-cover">
          </div>
        </div>
      `;
    }
  </script>
</body>
</html>